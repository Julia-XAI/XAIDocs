<!DOCTYPE html><HTML lang="en"><head><script charset="utf-8" src="../../../../assets/default/multidoc_injector.js" type="text/javascript"></script><script charset="utf-8" type="text/javascript">window.MULTIDOCUMENTER_ROOT_PATH = '/XAIDocs/'</script><script charset="utf-8" src="../../../../assets/default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../assets/default/flexsearch_integration.js" type="text/javascript"></script><meta charset="UTF-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><title>Creating an LRP Analyzer · RelevancePropagation.jl</title><meta content="Creating an LRP Analyzer · RelevancePropagation.jl" name="title"/><meta content="Creating an LRP Analyzer · RelevancePropagation.jl" property="og:title"/><meta content="Creating an LRP Analyzer · RelevancePropagation.jl" property="twitter:title"/><meta content="Documentation for RelevancePropagation.jl." name="description"/><meta content="Documentation for RelevancePropagation.jl." property="og:description"/><meta content="Documentation for RelevancePropagation.jl." property="twitter:description"/><script data-outdated-warner="" src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script data-main="../../assets/documenter.js" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" data-theme-name="documenter-dark" data-theme-primary-dark="" href="../../assets/themes/documenter-dark.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-light" data-theme-primary="" href="../../assets/themes/documenter-light.css" rel="stylesheet" type="text/css"/><script src="../../assets/themeswap.js"></script><link href="https://julia-xai.github.io/XAIDocs/RelevancePropagation/stable/generated/basics/" rel="canonical"/><link href="../../../../assets/default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../assets/default/flexsearch.css" rel="stylesheet" type="text/css"/></head><body><nav id="multi-page-nav"><div class="hidden-on-mobile" id="nav-items"><a class="nav-link nav-item" href="../../../../XAIDocs/">Getting Started</a><div class="nav-dropdown"><button class="nav-item dropdown-label">Methods</button><ul class="nav-dropdown-container"><a class="nav-link nav-item" href="../../../../ExplainableAI/">ExplainableAI.jl</a><a class="nav-link active nav-item" href="../../../">RelevancePropagation.jl</a></ul></div><div class="nav-dropdown"><button class="nav-item dropdown-label">Heatmapping</button><ul class="nav-dropdown-container"><a class="nav-link nav-item" href="../../../../VisionHeatmaps/">VisionHeatmaps.jl</a><a class="nav-link nav-item" href="../../../../TextHeatmaps/">TextHeatmaps.jl</a></ul></div><a class="nav-link nav-item" href="../../../../XAIBase/">Interface</a><div class="search nav-item"><input id="search-input" placeholder="Search..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding">/</div></div></div><button id="multidoc-toggler"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg></button></nav><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img alt="RelevancePropagation.jl logo" src="../../assets/logo.png"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">RelevancePropagation.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Basic Usage</span><ul><li class="is-active"><a class="tocitem" href="">Creating an LRP Analyzer</a><ul class="internal"><li><a class="tocitem" href="#Model-preparation"><span>Model preparation</span></a></li><li><a class="tocitem" href="#LRP-rules"><span>LRP rules</span></a></li><li><a class="tocitem" href="#Computing-layerwise-relevances"><span>Computing layerwise relevances</span></a></li><li><a class="tocitem" href="#Performance-tips"><span>Performance tips</span></a></li></ul></li><li><a class="tocitem" href="../composites/">Assigning Rules to Layers</a></li><li><a class="tocitem" href="../crp/">Concept Relevance Propagation</a></li></ul></li><li><span class="tocitem">Advanced Usage</span><ul><li><a class="tocitem" href="../custom_layer/">Supporting New Layer Types</a></li><li><a class="tocitem" href="../custom_rules/">Custom LRP Rules</a></li><li><a class="tocitem" href="../../developer/">Developer Documentation</a></li></ul></li><li><a class="tocitem" href="../../rules/">LRP Rule Overview</a></li><li><a class="tocitem" href="../../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" href="#" id="documenter-sidebar-button"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basic Usage</a></li><li class="is-active"><a href="">Creating an LRP Analyzer</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="">Creating an LRP Analyzer</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Julia-XAI/RelevancePropagation.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Julia-XAI/RelevancePropagation.jl/blob/main/docs/src/literate/basics.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" href="#" id="documenter-settings-button" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" href="javascript:;" id="documenter-article-toggle-button" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Creating-an-LRP-Analyzer"><a class="docs-heading-anchor" href="#Creating-an-LRP-Analyzer">Creating an LRP Analyzer</a><a id="Creating-an-LRP-Analyzer-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-an-LRP-Analyzer" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This package is part the <a href="https://github.com/Julia-XAI">Julia-XAI ecosystem</a>. For an introduction to the ecosystem, please refer to the <a href="https://julia-xai.github.io/XAIDocs/"><em>Getting started</em> guide</a>.</p></div></div><p>We start out by loading a small convolutional neural network:</p><pre><code class="language-julia hljs">using RelevancePropagation
using Flux

model = Chain(
    Chain(
        Conv((3, 3), 3 =&gt; 8, relu; pad=1),
        Conv((3, 3), 8 =&gt; 8, relu; pad=1),
        MaxPool((2, 2)),
        Conv((3, 3), 8 =&gt; 16; pad=1),
        BatchNorm(16, relu),
        Conv((3, 3), 16 =&gt; 8, relu; pad=1),
        BatchNorm(8, relu),
    ),
    Chain(Flux.flatten, Dense(2048 =&gt; 512, relu), Dropout(0.5), Dense(512 =&gt; 100, softmax)),
);</code></pre><p>This model contains two chains: the convolutional layers and the fully connected layers.</p><h2 id="Model-preparation"><a class="docs-heading-anchor" href="#Model-preparation">Model preparation</a><a id="Model-preparation-1"></a><a class="docs-heading-anchor-permalink" href="#Model-preparation" title="Permalink"></a></h2><div class="admonition is-info"><header class="admonition-header">TLDR</header><div class="admonition-body"><ol><li>Use <a href="../../api/#RelevancePropagation.strip_softmax"><code>strip_softmax</code></a> to strip the output softmax from your model. Otherwise <a href="../custom_layer/#model-checks">model checks</a> will fail.</li><li>Use <a href="../../api/#RelevancePropagation.canonize"><code>canonize</code></a> to fuse linear layers.</li><li>Don't just call <code>LRP(model)</code>, instead use a <a href="../../api/#RelevancePropagation.Composite"><code>Composite</code></a> to apply LRP rules to your model. Read <a href="../composites/#composites"><em>Assigning rules to layers</em></a> for more information.</li><li>By default, <code>LRP</code> will call <a href="../../api/#RelevancePropagation.flatten_model"><code>flatten_model</code></a> to flatten your model. This reduces computational overhead.</li></ol></div></div><h3 id="Stripping-the-output-softmax"><a class="docs-heading-anchor" href="#Stripping-the-output-softmax">Stripping the output softmax</a><a id="Stripping-the-output-softmax-1"></a><a class="docs-heading-anchor-permalink" href="#Stripping-the-output-softmax" title="Permalink"></a></h3><p>When using LRP, it is recommended to explain output logits instead of probabilities. This can be done by stripping the output softmax activation from the model using the <a href="../../api/#RelevancePropagation.strip_softmax"><code>strip_softmax</code></a> function:</p><pre><code class="language-julia hljs">model = strip_softmax(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Chain(
    Conv((3, 3), 3 =&gt; 8, relu, pad=1),  <span class="sgr90"># 224 parameters</span>
    Conv((3, 3), 8 =&gt; 8, relu, pad=1),  <span class="sgr90"># 584 parameters</span>
    MaxPool((2, 2)),
    Conv((3, 3), 8 =&gt; 16, pad=1),       <span class="sgr90"># 1_168 parameters</span>
    BatchNorm(16, relu),                <span class="sgr90"># 32 parameters, plus 32</span>
    Conv((3, 3), 16 =&gt; 8, relu, pad=1),  <span class="sgr90"># 1_160 parameters</span>
    BatchNorm(8, relu),                 <span class="sgr90"># 16 parameters, plus 16</span>
  ),
  Chain(
    Flux.flatten,
    Dense(2048 =&gt; 512, relu),           <span class="sgr90"># 1_049_088 parameters</span>
    Dropout(0.5),
    Dense(512 =&gt; 100),                  <span class="sgr90"># 51_300 parameters</span>
  ),
) <span class="sgr90">        # Total: 16 trainable arrays, </span>1_103_572 parameters,
<span class="sgr90">          # plus 4 non-trainable, 48 parameters, summarysize </span>4.213 MiB.</code></pre><p>If you don't remove the output softmax, <a href="../custom_layer/#model-checks">model checks</a> will fail.</p><h3 id="canonization"><a class="docs-heading-anchor" href="#canonization">Model canonization</a><a id="canonization-1"></a><a class="docs-heading-anchor-permalink" href="#canonization" title="Permalink"></a></h3><p>LRP is not invariant to a model's implementation. Applying the <a href="../../api/#RelevancePropagation.GammaRule"><code>GammaRule</code></a> to two linear layers in a row will yield different results than first fusing the two layers into one linear layer and then applying the rule. This fusing is called "canonization" and can be done using the <a href="../../api/#RelevancePropagation.canonize"><code>canonize</code></a> function:</p><pre><code class="language-julia hljs">model_canonized = canonize(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1),    <span class="sgr90"># 224 parameters</span>
  Conv((3, 3), 8 =&gt; 8, relu, pad=1),    <span class="sgr90"># 584 parameters</span>
  MaxPool((2, 2)),
  Conv((3, 3), 8 =&gt; 16, relu, pad=1),   <span class="sgr90"># 1_168 parameters</span>
  Conv((3, 3), 16 =&gt; 8, relu, pad=1),   <span class="sgr90"># 1_160 parameters</span>
  BatchNorm(8, relu),                   <span class="sgr90"># 16 parameters, plus 16</span>
  Flux.flatten,
  Dense(2048 =&gt; 512, relu),             <span class="sgr90"># 1_049_088 parameters</span>
  Dropout(0.5),
  Dense(512 =&gt; 100),                    <span class="sgr90"># 51_300 parameters</span>
) <span class="sgr90">        # Total: 14 trainable arrays, </span>1_103_540 parameters,
<span class="sgr90">          # plus 2 non-trainable, 16 parameters, summarysize </span>4.212 MiB.</code></pre><p>After canonization, the first <code>BatchNorm</code> layer has been fused into the preceding <code>Conv</code> layer. The second <code>BatchNorm</code> layer wasn't fused since its preceding <code>Conv</code> layer has a ReLU activation function.</p><h3 id="flatten-model"><a class="docs-heading-anchor" href="#flatten-model">Flattening the model</a><a id="flatten-model-1"></a><a class="docs-heading-anchor-permalink" href="#flatten-model" title="Permalink"></a></h3><p>RelevancePropagation.jl's LRP implementation supports nested Flux Chains and Parallel layers. However, it is recommended to flatten the model before analyzing it.</p><p>LRP is implemented by first running a forward pass through the model, keeping track of the intermediate activations, followed by a backward pass that computes the relevances.</p><p>To keep the LRP implementation simple and maintainable, RelevancePropagation.jl does not pre-compute "nested" activations. Instead, for every internal chain, a new forward pass is run to compute activations.</p><p>By "flattening" a model, this overhead can be avoided. For this purpose, RelevancePropagation.jl provides the function <a href="../../api/#RelevancePropagation.flatten_model"><code>flatten_model</code></a>:</p><pre><code class="language-julia hljs">model_flat = flatten_model(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1),    <span class="sgr90"># 224 parameters</span>
  Conv((3, 3), 8 =&gt; 8, relu, pad=1),    <span class="sgr90"># 584 parameters</span>
  MaxPool((2, 2)),
  Conv((3, 3), 8 =&gt; 16, pad=1),         <span class="sgr90"># 1_168 parameters</span>
  BatchNorm(16, relu),                  <span class="sgr90"># 32 parameters, plus 32</span>
  Conv((3, 3), 16 =&gt; 8, relu, pad=1),   <span class="sgr90"># 1_160 parameters</span>
  BatchNorm(8, relu),                   <span class="sgr90"># 16 parameters, plus 16</span>
  Flux.flatten,
  Dense(2048 =&gt; 512, relu),             <span class="sgr90"># 1_049_088 parameters</span>
  Dropout(0.5),
  Dense(512 =&gt; 100),                    <span class="sgr90"># 51_300 parameters</span>
) <span class="sgr90">        # Total: 16 trainable arrays, </span>1_103_572 parameters,
<span class="sgr90">          # plus 4 non-trainable, 48 parameters, summarysize </span>4.212 MiB.</code></pre><p>This function is called by default when creating an LRP analyzer. Note that we pass the unflattened model to the analyzer, but <code>analyzer.model</code> is flattened:</p><pre><code class="language-julia hljs">analyzer = LRP(model)
analyzer.model</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1),    <span class="sgr90"># 224 parameters</span>
  Conv((3, 3), 8 =&gt; 8, relu, pad=1),    <span class="sgr90"># 584 parameters</span>
  MaxPool((2, 2)),
  Conv((3, 3), 8 =&gt; 16, pad=1),         <span class="sgr90"># 1_168 parameters</span>
  BatchNorm(16, relu),                  <span class="sgr90"># 32 parameters, plus 32</span>
  Conv((3, 3), 16 =&gt; 8, relu, pad=1),   <span class="sgr90"># 1_160 parameters</span>
  BatchNorm(8, relu),                   <span class="sgr90"># 16 parameters, plus 16</span>
  Flux.flatten,
  Dense(2048 =&gt; 512, relu),             <span class="sgr90"># 1_049_088 parameters</span>
  Dropout(0.5),
  Dense(512 =&gt; 100),                    <span class="sgr90"># 51_300 parameters</span>
) <span class="sgr90">        # Total: 16 trainable arrays, </span>1_103_572 parameters,
<span class="sgr90">          # plus 4 non-trainable, 48 parameters, summarysize </span>4.212 MiB.</code></pre><p>If this flattening is not desired, it can be disabled by passing the keyword argument <code>flatten=false</code> to the <code>LRP</code> constructor.</p><h2 id="LRP-rules"><a class="docs-heading-anchor" href="#LRP-rules">LRP rules</a><a id="LRP-rules-1"></a><a class="docs-heading-anchor-permalink" href="#LRP-rules" title="Permalink"></a></h2><p>The following examples will be run on a pre-trained LeNet-5 model:</p><pre><code class="language-julia hljs">using BSON

model = BSON.load("../model.bson", @__MODULE__)[:model] # load pre-trained LeNet-5 model</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Conv((5, 5), 1 =&gt; 6, relu),           <span class="sgr90"># 156 parameters</span>
  MaxPool((2, 2)),
  Conv((5, 5), 6 =&gt; 16, relu),          <span class="sgr90"># 2_416 parameters</span>
  MaxPool((2, 2)),
  Flux.flatten,
  Dense(256 =&gt; 120, relu),              <span class="sgr90"># 30_840 parameters</span>
  Dense(120 =&gt; 84, relu),               <span class="sgr90"># 10_164 parameters</span>
  Dense(84 =&gt; 10),                      <span class="sgr90"># 850 parameters</span>
) <span class="sgr90">                  # Total: 10 arrays, </span>44_426 parameters, 174.867 KiB.</code></pre><p>We also load the MNIST dataset:</p><pre><code class="language-julia hljs">using MLDatasets
using ImageCore, ImageIO, ImageShow

index = 10
x, y = MNIST(Float32, :test)[10]
input = reshape(x, 28, 28, 1, :)

convert2image(MNIST, x)</code></pre><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAABwCAAAAADji6uXAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAjhJREFUaAW9wb2L1gUAB/DPcd+oQaPswCGqpSGHXqYTapGgJSg4CeoPcEiECqFDpCGwTdIQImuIsGiTtmjJgl6GoKEiIhqCoMQsOOhFy85r+A3H8fTo73mM7+cTZVEWZVEWZVEWZVEWZVEWZVEWZVEWZVEWZVEWZVEWZVEWZVEWZVEWZVEWc7gTS1jBHlzGSXyK71xZlEVZlMUM7sYB7MWSrXbjH3yLj/E0/jYpyqIsymKEe3AAj+NGgx/xEb7HKj7HMnbgYXyBkyZFWZRFWVzFq1jBksH7+AqHcdHgfuzH67gP5/AyTuO8raIsyqIsprgBq9iHBZzHKziKP2x1CxbxPN7DHaaLsiiLsphiD57FAn7CXnxmq0XchlN4FzcbLOBNrJkUZVEWZTHFItYNLmE3HsNdBhewC7vwC3badA4v4JJJURZlURZTnMEHeAi34wQ2DNaxaNNOg8t4B0/hrP8WZVEWZTHFBazgJhzCA/gVP+B63ItlW72Gw1gzXZRFWZTFVazhkEmnsGzwGw7iDay7siiLsiiLOaziCZv2423jRFmURVnMaB+eQwy+xmnjRVmURVnMYBkvYpvB73gSfxkvyqIsymIGj2C7wZ94FJ+YTZRFWZTFSNuxatNb+NDsoizKoixG2IZvcJ3Bl3jGfKIsyqIsRngQt2LD4CAumk+URVmUxQhHsGFwFGfML8qiLMpihB1YwM94ybWJsiiLshjhGI7hCM66NlEWZVEWIxzHcf+PKIuyKPsXNwdYfgiRxs8AAAAASUVORK5C"/><p>By default, the <code>LRP</code> constructor will assign the <a href="../../api/#RelevancePropagation.ZeroRule"><code>ZeroRule</code></a> to all layers.</p><pre><code class="language-julia hljs">analyzer = LRP(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">LRP(
  Conv((5, 5), 1 =&gt; 6, relu) <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  MaxPool((2, 2))            <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Conv((5, 5), 6 =&gt; 16, relu)<span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  MaxPool((2, 2))            <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Flux.flatten               <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Dense(256 =&gt; 120, relu)    <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Dense(120 =&gt; 84, relu)     <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Dense(84 =&gt; 10)            <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
)</code></pre><p>This ana lyzer will return heatmaps that look identical to the <code>InputTimesGradient</code> analyzer from <a href="https://github.com/Julia-XAI/ExplainableAI.jl">ExplainableAI.jl</a>. We can visualize <code>Explanation</code>s by computing a <code>heatmap</code> using either <a href="https://julia-xai.github.io/XAIDocs/VisionHeatmaps/stable/">VisionHeatmaps.jl</a> or <a href="https://julia-xai.github.io/XAIDocs/TextHeatmaps/stable/">TextHeatmaps.jl</a>, either for images or text, respectively.</p><pre><code class="language-julia hljs">using VisionHeatmaps

heatmap(input, analyzer)</code></pre><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAABwCAIAAABJgmMcAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAABBtJREFUeAHtwU9I1gcYwPGvvk9qv/fVF9KyDpmZoisZlTUK+kMdtkUdIiiD4bGOa4PYYQ62S4Ug/bl06RCd2lrQcK5asGgs6OCCRRtGWYeNDmVbLNNme/Xd6XnsIETy+Po6ns9H8vk8wY8QXAnBlRBcCcGVEFwJwZUQXAnBlRBcCcGVEFwJwZUQXAnBlRBcCcGVEFwJwZUQXAnBlRBcCcGVEFwJwZUQXAnBlRBcCUUsl2NS0vsN5swZTEMDprMT9U8yD1VRwbQSgishuBKCK6EYDA9jRkZQcu8e5tEjzOAgJpXClJZiBgZQFbW1qO9+XYLKZjHr12NSKaZMCK6E4EoIroRCev4cNZTPoO7eTaPaWpjw9CmmtRVz6xZm3z5Mfz/m5EnMqlWoxvcPoOrqMIODmIULmTIhuBKCKyG4EqbZ+Djm+58yqIcPMbdvY+o+S6MyW7ej5paPY5qamFRtLWr8w49Qw8OY5h97MTeeoOaWl2P27MGkUrwJIbgSgishuBK85POYBw9Qv/y9DLVzJ+blS8zly5hsFlNWxitKeZ3DF1ei9lZhkgRTuWED5vp1zKZNmHyeqRKCKyG4EoIrwUlurAT1w8AyVDaLOXIEs3YtZuNG3sj4OGZoCPPpJznMjRuYJEGdu9+GWr58B6q14iUmlWKqhOBKCK6E4EpwIi+GUO/98RXm5Leot3p6UNlLlzDtp1Gj586hyvv6MKdOoUoPHEBlDx3CNDRgVq7EbN6M2lKH6e3FLF5chsqWMWVCcCUEV0JwJXiprMRUVqJGenpQx3nFtm2oUiZkmPBxVxfq6/PnUbuHhjD372NGRzFVVZjmZtT8pXNRHR1plAguhOBKCK6E4EqYDu3tqGT7dtTnu3ZhVqxA/Xv8OGpOYyMmnUbtbmtDjZw9i0q6uzHPnmFyOUxZGSZJUFKCOyG4EoIrIbgSplsmg7lyhcnMOXaM1zpxAvX7zZuolqtXMQ0NmIMHMUuWUChCcCUEV0JwJRSzsTFMTQ2qZfVqTDqN6erCJAkzQQiuhOBKCK6EItPZiTl8+DdU/vG7qJ+bP0CtWYPJ5zElzAwhuBKCKyG4EopAby/m6FHMli1vo7a2Yx4/xly4gGlqYsYJwZUQXAnBlVAEBgcxS5di5s3DtLZiduzANDVRVITgSgiuhOBKmCEvXmCuXcP09w+jqqrSqO5uTH09RUsIroTgSgiuhBnS14fZvx8zOppGrVuHqa9nVhCCKyG4EoIroZAGBlCbKv5CXXzyDurLL+6g/pzfwmwjBFdCcCUEV0IhnT6N6ehAralnQmkNqrqaWUcIroTgSgiuhEJatAizYAEmx4TqamYzIbgSgishuBIKae9ezNgYKkmYUFLCbCYEV0JwJQRXQiHV1DCZDP8fQnAlBFdCcPUfZaDIbeMVzvAAAAAASUVORK5C"/><p>LRP's strength lies in assigning different rules to different layers, based on their functionality in the neural network<sup class="footnote-reference"><a href="#footnote-1" id="citeref-1">[1]</a></sup>. RelevancePropagation.jl <a href="../../rules/#rules">implements many LRP rules out of the box</a>, but it is also possible to <a href="../custom_rules/#custom-rules"><em>implement custom rules</em></a>.</p><p>To assign different rules to different layers, use one of the <a href="../../api/#api-composite-presets">composites presets</a>, or create your own composite, as described in <a href="../composites/#composites"><em>Assigning rules to layers</em></a>.</p><pre><code class="language-julia hljs">composite = EpsilonPlusFlat() # using composite preset EpsilonPlusFlat</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Composite(
  GlobalTypeMap(  <span class="sgr90"># all layers</span>
<span class="sgr94">    Flux.Conv              </span> =&gt; <span class="sgr33">ZPlusRule()</span>,
<span class="sgr94">    Flux.ConvTranspose     </span> =&gt; <span class="sgr33">ZPlusRule()</span>,
<span class="sgr94">    Flux.CrossCor          </span> =&gt; <span class="sgr33">ZPlusRule()</span>,
<span class="sgr94">    Flux.Dense             </span> =&gt; <span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
<span class="sgr94">    Flux.Scale             </span> =&gt; <span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
<span class="sgr94">    Flux.LayerNorm         </span> =&gt; <span class="sgr33">LayerNormRule()</span>,
<span class="sgr94">    typeof(NNlib.dropout)  </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    Flux.AlphaDropout      </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    Flux.Dropout           </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    Flux.BatchNorm         </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    typeof(Flux.flatten)   </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    typeof(MLUtils.flatten)</span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    typeof(identity)       </span> =&gt; <span class="sgr33">PassRule()</span>,
 ),
  FirstLayerTypeMap(  <span class="sgr90"># first layer</span>
<span class="sgr94">    Flux.Conv         </span> =&gt; <span class="sgr33">FlatRule()</span>,
<span class="sgr94">    Flux.ConvTranspose</span> =&gt; <span class="sgr33">FlatRule()</span>,
<span class="sgr94">    Flux.CrossCor     </span> =&gt; <span class="sgr33">FlatRule()</span>,
 ),
)</code></pre><pre><code class="language-julia hljs">analyzer = LRP(model, composite)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">LRP(
  Conv((5, 5), 1 =&gt; 6, relu) <span class="sgr90"> =&gt; </span><span class="sgr33">FlatRule()</span>,
  MaxPool((2, 2))            <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Conv((5, 5), 6 =&gt; 16, relu)<span class="sgr90"> =&gt; </span><span class="sgr33">ZPlusRule()</span>,
  MaxPool((2, 2))            <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Flux.flatten               <span class="sgr90"> =&gt; </span><span class="sgr33">PassRule()</span>,
  Dense(256 =&gt; 120, relu)    <span class="sgr90"> =&gt; </span><span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
  Dense(120 =&gt; 84, relu)     <span class="sgr90"> =&gt; </span><span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
  Dense(84 =&gt; 10)            <span class="sgr90"> =&gt; </span><span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
)</code></pre><pre><code class="language-julia hljs">heatmap(input, analyzer)</code></pre><img src="data:image/png;base64,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"/><h2 id="Computing-layerwise-relevances"><a class="docs-heading-anchor" href="#Computing-layerwise-relevances">Computing layerwise relevances</a><a id="Computing-layerwise-relevances-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-layerwise-relevances" title="Permalink"></a></h2><p>If you are interested in computing layerwise relevances, call <code>analyze</code> with an LRP analyzer and the keyword argument <code>layerwise_relevances=true</code>.</p><p>The layerwise relevances can be accessed in the <code>extras</code> field of the returned <code>Explanation</code>:</p><pre><code class="language-julia hljs">expl = analyze(input, analyzer; layerwise_relevances=true)
expl.extras.layerwise_relevances</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(Float32[-1.5046089f-6 -1.5046089f-6 … 4.4148962f-8 0.0; -1.5046089f-6 -1.5046089f-6 … 4.4148962f-8 0.0; … ; 6.1168203f-6 6.1168203f-6 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;;;], Float32[-3.7615224f-5 0.0 … 1.103724f-6 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0001529205 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;;;], Float32[-3.7615224f-5 0.00021888175 … 0.000114222385 1.103724f-6; 0.00018855373 0.00027439542 … 0.00020195934 -3.4702516f-5; … ; -2.6229336f-5 7.008412f-5 … -2.8691686f-6 0.0; 0.0001529205 0.00029437395 … 0.0 0.0;;; 0.0 0.0 … -0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 -0.0; 0.0 0.0 … -0.0 0.0;;; -0.0 0.0 … -0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; -0.0 0.0 … 0.0 0.0;;; -0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; -0.0 0.0 … 0.0 0.0; 0.0 -0.0 … 0.0 0.0;;; 0.0 -0.0 … -0.0 0.0; -0.0 0.0 … 0.0 0.0; … ; 0.0 -0.0 … -0.0 0.0; 0.0 0.0 … -0.0 0.0;;; 0.0 -0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 -0.0; 0.0 0.0 … 0.0 0.0;;;;], Float32[0.0 0.0 … 0.0 0.0; -0.0027488603 0.0 … 0.02671153 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.03954778 0.0 … 0.0 -0.0014172087;;; -0.0014038438 0.0 … 0.0 -0.00047513167; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.004709776 … 0.0 0.0;;; 0.0 0.0 … 0.0 -0.002364168; 0.0 0.0 … 0.0 0.0; … ; 0.00063266495 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; … ;;; 0.0 0.0 … 0.0 -0.014013007; 0.0 0.014055459 … 0.0 0.0; … ; 0.0 0.0 … -0.00013713303 0.0; 0.037856653 0.0 … 0.0 0.0;;; -0.0033661663 0.0 … 0.008260983 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.01444692 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 -0.038602687; … ; 0.0 0.0014011612 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;;;], Float32[-0.0027488603 -0.0 0.0006903657 0.02671153; -0.0043666936 -0.01234732 0.0 -0.013395859; -0.010977116 0.04276983 -0.0 -9.9327546f-5; 0.03954778 0.0 -0.0 -0.0014172087;;; -0.0014038438 0.017887121 0.0 -0.0004751317; -0.0 0.016042996 -0.0 -0.0; 0.011004027 0.0 -0.0 -0.0; 0.004709776 -0.009777178 -0.0 0.0;;; -0.0 -0.025314394 -0.011204087 -0.002364168; 0.027246127 -0.016887693 0.0 -0.010472963; 0.00095062767 -0.00031839436 -0.022801049 0.0036320935; 0.00063266495 -0.0028789637 0.011017141 0.0;;; … ;;; 0.014055459 0.011828159 -0.0 -0.014013007; 0.01990776 0.017337693 -0.0001569362 -0.0; -0.011918854 -0.00459134 0.0 -0.004262696; 0.037856653 0.023232974 0.0 -0.00013713304;;; -0.0033661663 -0.0 0.01047569 0.008260983; -0.0 0.010837908 0.06946186 0.0038659107; 0.0 -0.0063336077 0.029801883 0.02022359; -0.0 -0.001508267 -0.0047802655 0.01444692;;; -0.0 0.060284954 0.0021190182 -0.038602687; -0.0 0.0 0.015209901 0.0; -0.037314404 0.0054231985 0.0 0.0; 0.0014011612 0.0 0.0 0.0;;;;], Float32[-0.0027488603; -0.0043666936; … ; 0.0; 0.0;;], Float32[0.0; 0.0; … ; -0.0; 0.0;;], Float32[0.028250216; 0.026568355; … ; -0.0; 0.032229893;;], Float32[0.0; 0.0; … ; 0.0; 1.0;;])</code></pre><p>Note that the layerwise relevances are only kept for layers in the outermost <code>Chain</code> of the model. Since we used a flattened model, we obtained all relevances.</p><h2 id="Performance-tips"><a class="docs-heading-anchor" href="#Performance-tips">Performance tips</a><a id="Performance-tips-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-tips" title="Permalink"></a></h2><h3 id="Using-LRP-with-a-GPU"><a class="docs-heading-anchor" href="#Using-LRP-with-a-GPU">Using LRP with a GPU</a><a id="Using-LRP-with-a-GPU-1"></a><a class="docs-heading-anchor-permalink" href="#Using-LRP-with-a-GPU" title="Permalink"></a></h3><p>All LRP analyzers support GPU backends, building on top of <a href="https://fluxml.ai/Flux.jl/stable/gpu/">Flux.jl's GPU support</a>. Using a GPU only requires moving the input array and model weights to the GPU.</p><p>For example, using <a href="https://github.com/JuliaGPU/CUDA.jl">CUDA.jl</a>:</p><pre><code class="language-julia hljs">using CUDA, cuDNN
using Flux
using RelevancePropagation

# move input array and model weights to GPU
input = input |&gt; gpu # or gpu(input)
model = model |&gt; gpu # or gpu(model)

# analyzers don't require calling `gpu`
analyzer = LRP(model)

# explanations are computed on the GPU
expl = analyze(input, analyzer)</code></pre><p>Some operations, like saving, require moving explanations back to the CPU. This can be done using Flux's <code>cpu</code> function:</p><pre><code class="language-julia hljs">val = expl.val |&gt; cpu # or cpu(expl.val)

using BSON
BSON.@save "explanation.bson" val</code></pre><h3 id="Using-LRP-without-a-GPU"><a class="docs-heading-anchor" href="#Using-LRP-without-a-GPU">Using LRP without a GPU</a><a id="Using-LRP-without-a-GPU-1"></a><a class="docs-heading-anchor-permalink" href="#Using-LRP-without-a-GPU" title="Permalink"></a></h3><p>Using Julia's package extension mechanism, RelevancePropagation.jl's LRP implementation can optionally make use of <a href="https://github.com/mcabbott/Tullio.jl">Tullio.jl</a> and <a href="https://github.com/JuliaSIMD/LoopVectorization.jl">LoopVectorization.jl</a> for faster LRP rules on dense layers.</p><p>This only requires loading the packages before loading RelevancePropagation.jl:</p><pre><code class="language-julia hljs">using LoopVectorization, Tullio
using RelevancePropagation</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>G. Montavon et al., <a href="https://link.springer.com/chapter/10.1007/978-3-030-28954-6_10">Layer-Wise Relevance Propagation: An Overview</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><a class="docs-footer-nextpage" href="../composites/">Assigning Rules to Layers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label></p><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div><p></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Wednesday 6 March 2024 15:58">Wednesday 6 March 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></HTML>