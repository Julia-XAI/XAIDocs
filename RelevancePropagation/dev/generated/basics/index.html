<!DOCTYPE html><HTML lang="en"><head><script charset="utf-8" src="../../../../assets/default/multidoc_injector.js" type="text/javascript"></script><script charset="utf-8" type="text/javascript">window.MULTIDOCUMENTER_ROOT_PATH = '/XAIDocs/'</script><script charset="utf-8" src="../../../../assets/default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../assets/default/flexsearch_integration.js" type="text/javascript"></script><meta charset="UTF-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><title>Basic usage · RelevancePropagation.jl</title><meta content="Basic usage · RelevancePropagation.jl" name="title"/><meta content="Basic usage · RelevancePropagation.jl" property="og:title"/><meta content="Basic usage · RelevancePropagation.jl" property="twitter:title"/><meta content="Documentation for RelevancePropagation.jl." name="description"/><meta content="Documentation for RelevancePropagation.jl." property="og:description"/><meta content="Documentation for RelevancePropagation.jl." property="twitter:description"/><script data-outdated-warner="" src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script data-main="../../assets/documenter.js" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" data-theme-name="documenter-dark" data-theme-primary-dark="" href="../../assets/themes/documenter-dark.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-light" data-theme-primary="" href="../../assets/themes/documenter-light.css" rel="stylesheet" type="text/css"/><script src="../../assets/themeswap.js"></script><link href="https://julia-xai.github.io/XAIDocs/RelevancePropagation/dev/generated/basics/" rel="canonical"/><link href="../../../../assets/default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../assets/default/flexsearch.css" rel="stylesheet" type="text/css"/></head><body><nav id="multi-page-nav"><div class="hidden-on-mobile" id="nav-items"><a class="nav-link nav-item" href="../../../../XAIBase/">Getting Started</a><div class="nav-dropdown"><button class="nav-item dropdown-label">Methods</button><ul class="nav-dropdown-container"><a class="nav-link nav-item" href="../../../../ExplainableAI/">ExplainableAI.jl</a><a class="nav-link active nav-item" href="../../../">RelevancePropagation.jl</a></ul></div><div class="nav-dropdown"><button class="nav-item dropdown-label">Heatmapping</button><ul class="nav-dropdown-container"><a class="nav-link nav-item" href="../../../../VisionHeatmaps/">VisionHeatmaps.jl</a><a class="nav-link nav-item" href="../../../../TextHeatmaps/">TextHeatmaps.jl</a></ul></div><a class="nav-link nav-item" href="../../../../XAIBase/">Interface</a><div class="search nav-item"><input id="search-input" placeholder="Search..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding">/</div></div></div><button id="multidoc-toggler"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg></button></nav><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img alt="RelevancePropagation.jl logo" src="../../assets/logo.png"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">RelevancePropagation.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li class="is-active"><a class="tocitem" href="">Basic usage</a><ul class="internal"><li><a class="tocitem" href="#docs-lrp-model-prep"><span>Model preparation</span></a></li><li><a class="tocitem" href="#LRP-rules"><span>LRP rules</span></a></li><li><a class="tocitem" href="#docs-lrp-layerwise"><span>Computing layerwise relevances</span></a></li><li><a class="tocitem" href="#docs-lrp-performance"><span>Performance tips</span></a></li></ul></li><li><span class="tocitem">Advanced usage</span><ul><li><a class="tocitem" href="../composites/">Assigning rules to layers</a></li><li><a class="tocitem" href="../custom_layer/">Supporting new layer types</a></li><li><a class="tocitem" href="../custom_rules/">Custom LRP rules</a></li><li><a class="tocitem" href="../crp/">Concept Relevance Propagation</a></li><li><a class="tocitem" href="../../developer/">Developer documentation</a></li></ul></li><li><a class="tocitem" href="../../api/">API reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" href="#" id="documenter-sidebar-button"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="">Basic usage</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="">Basic usage</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Julia-XAI/RelevancePropagation.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Julia-XAI/RelevancePropagation.jl/blob/main/docs/src/literate/basics.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" href="#" id="documenter-settings-button" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" href="javascript:;" id="documenter-article-toggle-button" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="docs-lrp-basics"><a class="docs-heading-anchor" href="#docs-lrp-basics">Basic usage of LRP</a><a id="docs-lrp-basics-1"></a><a class="docs-heading-anchor-permalink" href="#docs-lrp-basics" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Getting started</header><div class="admonition-body"></div></div><p>This package is part the <a href="https://github.com/Julia-XAI">Julia-XAI ecosystem</a> and builds on the basics shown in the <a href="https://julia-xai.github.io/ExplainableAI.jl/stable/generated/example/"><em>Getting started</em> guide from ExplainableAI.jl</a>.</p><div class="admonition is-info"><header class="admonition-header">TLDR</header><div class="admonition-body"><ol><li>Use <a href="../../api/#RelevancePropagation.strip_softmax"><code>strip_softmax</code></a> to strip the output softmax from your model. Otherwise <a href="../custom_layer/#docs-lrp-model-checks">model checks</a> will fail.</li><li>Use <a href="../../api/#RelevancePropagation.canonize"><code>canonize</code></a> to fuse linear layers.</li><li>Don't just call <code>LRP(model)</code>, instead use a <a href="../../api/#RelevancePropagation.Composite"><code>Composite</code></a> to apply LRP rules to your model. Read <a href="../composites/#docs-composites"><em>Assigning rules to layers</em></a>.</li><li>By default, <code>LRP</code> will call <a href="../../api/#RelevancePropagation.flatten_model"><code>flatten_model</code></a> to flatten your model. This reduces computational overhead.</li></ol></div></div><p>We start out by loading a small convolutional neural network:</p><pre><code class="language-julia hljs">using RelevancePropagation
using Flux

model = Chain(
    Chain(
        Conv((3, 3), 3 =&gt; 8, relu; pad=1),
        Conv((3, 3), 8 =&gt; 8, relu; pad=1),
        MaxPool((2, 2)),
        Conv((3, 3), 8 =&gt; 16; pad=1),
        BatchNorm(16, relu),
        Conv((3, 3), 16 =&gt; 8, relu; pad=1),
        BatchNorm(8, relu),
    ),
    Chain(Flux.flatten, Dense(2048 =&gt; 512, relu), Dropout(0.5), Dense(512 =&gt; 100, softmax)),
);</code></pre><p>This model contains two chains: the convolutional layers and the fully connected layers.</p><h2 id="docs-lrp-model-prep"><a class="docs-heading-anchor" href="#docs-lrp-model-prep">Model preparation</a><a id="docs-lrp-model-prep-1"></a><a class="docs-heading-anchor-permalink" href="#docs-lrp-model-prep" title="Permalink"></a></h2><h3 id="docs-lrp-strip-softmax"><a class="docs-heading-anchor" href="#docs-lrp-strip-softmax">Stripping the output softmax</a><a id="docs-lrp-strip-softmax-1"></a><a class="docs-heading-anchor-permalink" href="#docs-lrp-strip-softmax" title="Permalink"></a></h3><p>When using LRP, it is recommended to explain output logits instead of probabilities. This can be done by stripping the output softmax activation from the model using the <a href="../../api/#RelevancePropagation.strip_softmax"><code>strip_softmax</code></a> function:</p><pre><code class="language-julia hljs">model = strip_softmax(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Chain(
    Conv((3, 3), 3 =&gt; 8, relu, pad=1),  <span class="sgr90"># 224 parameters</span>
    Conv((3, 3), 8 =&gt; 8, relu, pad=1),  <span class="sgr90"># 584 parameters</span>
    MaxPool((2, 2)),
    Conv((3, 3), 8 =&gt; 16, pad=1),       <span class="sgr90"># 1_168 parameters</span>
    BatchNorm(16, relu),                <span class="sgr90"># 32 parameters, plus 32</span>
    Conv((3, 3), 16 =&gt; 8, relu, pad=1),  <span class="sgr90"># 1_160 parameters</span>
    BatchNorm(8, relu),                 <span class="sgr90"># 16 parameters, plus 16</span>
  ),
  Chain(
    Flux.flatten,
    Dense(2048 =&gt; 512, relu),           <span class="sgr90"># 1_049_088 parameters</span>
    Dropout(0.5),
    Dense(512 =&gt; 100),                  <span class="sgr90"># 51_300 parameters</span>
  ),
) <span class="sgr90">        # Total: 16 trainable arrays, </span>1_103_572 parameters,
<span class="sgr90">          # plus 4 non-trainable, 48 parameters, summarysize </span>4.213 MiB.</code></pre><p>If you don't remove the output softmax, <a href="../custom_layer/#docs-lrp-model-checks">model checks</a> will fail.</p><h3 id="docs-lrp-canonization"><a class="docs-heading-anchor" href="#docs-lrp-canonization">Canonizing the model</a><a id="docs-lrp-canonization-1"></a><a class="docs-heading-anchor-permalink" href="#docs-lrp-canonization" title="Permalink"></a></h3><p>LRP is not invariant to a model's implementation. Applying the <a href="../../api/#RelevancePropagation.GammaRule"><code>GammaRule</code></a> to two linear layers in a row will yield different results than first fusing the two layers into one linear layer and then applying the rule. This fusing is called "canonization" and can be done using the <a href="../../api/#RelevancePropagation.canonize"><code>canonize</code></a> function:</p><pre><code class="language-julia hljs">model_canonized = canonize(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1),    <span class="sgr90"># 224 parameters</span>
  Conv((3, 3), 8 =&gt; 8, relu, pad=1),    <span class="sgr90"># 584 parameters</span>
  MaxPool((2, 2)),
  Conv((3, 3), 8 =&gt; 16, relu, pad=1),   <span class="sgr90"># 1_168 parameters</span>
  Conv((3, 3), 16 =&gt; 8, relu, pad=1),   <span class="sgr90"># 1_160 parameters</span>
  BatchNorm(8, relu),                   <span class="sgr90"># 16 parameters, plus 16</span>
  Flux.flatten,
  Dense(2048 =&gt; 512, relu),             <span class="sgr90"># 1_049_088 parameters</span>
  Dropout(0.5),
  Dense(512 =&gt; 100),                    <span class="sgr90"># 51_300 parameters</span>
) <span class="sgr90">        # Total: 14 trainable arrays, </span>1_103_540 parameters,
<span class="sgr90">          # plus 2 non-trainable, 16 parameters, summarysize </span>4.212 MiB.</code></pre><p>After canonization, the first <code>BatchNorm</code> layer has been fused into the preceding <code>Conv</code> layer. The second <code>BatchNorm</code> layer wasn't fused since its preceding <code>Conv</code> layer has a ReLU activation function.</p><h3 id="docs-lrp-flatten-model"><a class="docs-heading-anchor" href="#docs-lrp-flatten-model">Flattening the model</a><a id="docs-lrp-flatten-model-1"></a><a class="docs-heading-anchor-permalink" href="#docs-lrp-flatten-model" title="Permalink"></a></h3><p>RelevancePropagation.jl's LRP implementation supports nested Flux Chains and Parallel layers. However, it is recommended to flatten the model before analyzing it.</p><p>LRP is implemented by first running a forward pass through the model, keeping track of the intermediate activations, followed by a backward pass that computes the relevances.</p><p>To keep the LRP implementation simple and maintainable, RelevancePropagation.jl does not pre-compute "nested" activations. Instead, for every internal chain, a new forward pass is run to compute activations.</p><p>By "flattening" a model, this overhead can be avoided. For this purpose, RelevancePropagation.jl provides the function <a href="../../api/#RelevancePropagation.flatten_model"><code>flatten_model</code></a>:</p><pre><code class="language-julia hljs">model_flat = flatten_model(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1),    <span class="sgr90"># 224 parameters</span>
  Conv((3, 3), 8 =&gt; 8, relu, pad=1),    <span class="sgr90"># 584 parameters</span>
  MaxPool((2, 2)),
  Conv((3, 3), 8 =&gt; 16, pad=1),         <span class="sgr90"># 1_168 parameters</span>
  BatchNorm(16, relu),                  <span class="sgr90"># 32 parameters, plus 32</span>
  Conv((3, 3), 16 =&gt; 8, relu, pad=1),   <span class="sgr90"># 1_160 parameters</span>
  BatchNorm(8, relu),                   <span class="sgr90"># 16 parameters, plus 16</span>
  Flux.flatten,
  Dense(2048 =&gt; 512, relu),             <span class="sgr90"># 1_049_088 parameters</span>
  Dropout(0.5),
  Dense(512 =&gt; 100),                    <span class="sgr90"># 51_300 parameters</span>
) <span class="sgr90">        # Total: 16 trainable arrays, </span>1_103_572 parameters,
<span class="sgr90">          # plus 4 non-trainable, 48 parameters, summarysize </span>4.212 MiB.</code></pre><p>This function is called by default when creating an LRP analyzer. Note that we pass the unflattened model to the analyzer, but <code>analyzer.model</code> is flattened:</p><pre><code class="language-julia hljs">analyzer = LRP(model)
analyzer.model</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chain(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1),    <span class="sgr90"># 224 parameters</span>
  Conv((3, 3), 8 =&gt; 8, relu, pad=1),    <span class="sgr90"># 584 parameters</span>
  MaxPool((2, 2)),
  Conv((3, 3), 8 =&gt; 16, pad=1),         <span class="sgr90"># 1_168 parameters</span>
  BatchNorm(16, relu),                  <span class="sgr90"># 32 parameters, plus 32</span>
  Conv((3, 3), 16 =&gt; 8, relu, pad=1),   <span class="sgr90"># 1_160 parameters</span>
  BatchNorm(8, relu),                   <span class="sgr90"># 16 parameters, plus 16</span>
  Flux.flatten,
  Dense(2048 =&gt; 512, relu),             <span class="sgr90"># 1_049_088 parameters</span>
  Dropout(0.5),
  Dense(512 =&gt; 100),                    <span class="sgr90"># 51_300 parameters</span>
) <span class="sgr90">        # Total: 16 trainable arrays, </span>1_103_572 parameters,
<span class="sgr90">          # plus 4 non-trainable, 48 parameters, summarysize </span>4.212 MiB.</code></pre><p>If this flattening is not desired, it can be disabled by passing the keyword argument <code>flatten=false</code> to the <code>LRP</code> constructor.</p><h2 id="LRP-rules"><a class="docs-heading-anchor" href="#LRP-rules">LRP rules</a><a id="LRP-rules-1"></a><a class="docs-heading-anchor-permalink" href="#LRP-rules" title="Permalink"></a></h2><p>By default, the <code>LRP</code> constructor will assign the <a href="../../api/#RelevancePropagation.ZeroRule"><code>ZeroRule</code></a> to all layers.</p><pre><code class="language-julia hljs">LRP(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">LRP(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1) <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Conv((3, 3), 8 =&gt; 8, relu, pad=1) <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  MaxPool((2, 2))                   <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Conv((3, 3), 8 =&gt; 16, pad=1)      <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  BatchNorm(16, relu)               <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Conv((3, 3), 16 =&gt; 8, relu, pad=1)<span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  BatchNorm(8, relu)                <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Flux.flatten                      <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Dense(2048 =&gt; 512, relu)          <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Dropout(0.5)                      <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Dense(512 =&gt; 100)                 <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
)</code></pre><p>This analyzer will return heatmaps that look identical to the <code>InputTimesGradient</code> analyzer from <a href="https://github.com/Julia-XAI/ExplainableAI.jl">ExplainableAI.jl</a>.</p><p>LRP's strength lies in assigning different rules to different layers, based on their functionality in the neural network<sup class="footnote-reference"><a href="#footnote-1" id="citeref-1">[1]</a></sup>. RelevancePropagation.jl <a href="../../api/#api-lrp-rules">implements many LRP rules out of the box</a>, but it is also possible to <a href="../custom_rules/#docs-custom-rules"><em>implement custom rules</em></a>.</p><p>To assign different rules to different layers, use one of the <a href="../../api/#api-composite-presets">composites presets</a>, or create your own composite, as described in <a href="../composites/#docs-composites"><em>Assigning rules to layers</em></a>.</p><pre><code class="language-julia hljs">composite = EpsilonPlusFlat() # using composite preset EpsilonPlusFlat</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Composite(
  GlobalTypeMap(  <span class="sgr90"># all layers</span>
<span class="sgr94">    Flux.Conv              </span> =&gt; <span class="sgr33">ZPlusRule()</span>,
<span class="sgr94">    Flux.ConvTranspose     </span> =&gt; <span class="sgr33">ZPlusRule()</span>,
<span class="sgr94">    Flux.CrossCor          </span> =&gt; <span class="sgr33">ZPlusRule()</span>,
<span class="sgr94">    Flux.Dense             </span> =&gt; <span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
<span class="sgr94">    typeof(NNlib.dropout)  </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    Flux.AlphaDropout      </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    Flux.Dropout           </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    Flux.BatchNorm         </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    typeof(Flux.flatten)   </span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    typeof(MLUtils.flatten)</span> =&gt; <span class="sgr33">PassRule()</span>,
<span class="sgr94">    typeof(identity)       </span> =&gt; <span class="sgr33">PassRule()</span>,
 ),
  FirstLayerTypeMap(  <span class="sgr90"># first layer</span>
<span class="sgr94">    Flux.Conv         </span> =&gt; <span class="sgr33">FlatRule()</span>,
<span class="sgr94">    Flux.ConvTranspose</span> =&gt; <span class="sgr33">FlatRule()</span>,
<span class="sgr94">    Flux.CrossCor     </span> =&gt; <span class="sgr33">FlatRule()</span>,
 ),
)</code></pre><pre><code class="language-julia hljs">LRP(model, composite)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">LRP(
  Conv((3, 3), 3 =&gt; 8, relu, pad=1) <span class="sgr90"> =&gt; </span><span class="sgr33">FlatRule()</span>,
  Conv((3, 3), 8 =&gt; 8, relu, pad=1) <span class="sgr90"> =&gt; </span><span class="sgr33">ZPlusRule()</span>,
  MaxPool((2, 2))                   <span class="sgr90"> =&gt; </span><span class="sgr33">ZeroRule()</span>,
  Conv((3, 3), 8 =&gt; 16, pad=1)      <span class="sgr90"> =&gt; </span><span class="sgr33">ZPlusRule()</span>,
  BatchNorm(16, relu)               <span class="sgr90"> =&gt; </span><span class="sgr33">PassRule()</span>,
  Conv((3, 3), 16 =&gt; 8, relu, pad=1)<span class="sgr90"> =&gt; </span><span class="sgr33">ZPlusRule()</span>,
  BatchNorm(8, relu)                <span class="sgr90"> =&gt; </span><span class="sgr33">PassRule()</span>,
  Flux.flatten                      <span class="sgr90"> =&gt; </span><span class="sgr33">PassRule()</span>,
  Dense(2048 =&gt; 512, relu)          <span class="sgr90"> =&gt; </span><span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
  Dropout(0.5)                      <span class="sgr90"> =&gt; </span><span class="sgr33">PassRule()</span>,
  Dense(512 =&gt; 100)                 <span class="sgr90"> =&gt; </span><span class="sgr33">EpsilonRule{Float32}(1.0f-6)</span>,
)</code></pre><h2 id="docs-lrp-layerwise"><a class="docs-heading-anchor" href="#docs-lrp-layerwise">Computing layerwise relevances</a><a id="docs-lrp-layerwise-1"></a><a class="docs-heading-anchor-permalink" href="#docs-lrp-layerwise" title="Permalink"></a></h2><p>If you are interested in computing layerwise relevances, call <code>analyze</code> with an LRP analyzer and the keyword argument <code>layerwise_relevances=true</code>.</p><p>The layerwise relevances can be accessed in the <code>extras</code> field of the returned <code>Explanation</code>:</p><pre><code class="language-julia hljs">input = rand(Float32, 32, 32, 3, 1) # dummy input for our convolutional neural network

expl = analyze(input, analyzer; layerwise_relevances=true)
expl.extras.layerwise_relevances</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(Float32[-0.1275609 -1.3112487 … -0.0068535605 0.02883597; 0.07118586 -3.5561182 … -0.06709068 -0.0010300319; … ; 0.055174816 0.18256684 … 0.17445 0.0009664969; -0.048208293 -0.104294226 … -0.031605538 -0.026987849;;; -2.694294 0.6131237 … 0.049262393 -0.08285548; -1.9381986 -0.0048850854 … 0.06142935 0.0019868284; … ; 0.47733736 -0.13775285 … 0.18340716 -0.0059301327; 0.057681274 0.009278019 … 0.009487516 0.13631661;;; 3.1442387 1.2612364 … -0.009199413 -0.0026037467; -1.3929613 1.1536998 … 0.01232103 0.005355903; … ; 0.15727653 -0.026291087 … 0.054055978 -0.004201811; -0.07609102 -0.31831765 … -0.0073550767 0.08403184;;;;], Float32[-0.0 -0.0 … -0.0 0.0; 0.07062351 -3.9965959 … -0.051475156 0.0076942793; … ; 0.089814074 0.09768512 … 0.39613894 -0.09362398; 0.0 0.05412516 … 0.0 0.03606922;;; -0.6460781 0.94605696 … 0.06893336 -0.10094672; 0.0 0.0 … 0.0 -0.0; … ; -0.0 0.0 … 0.0 0.013808484; 0.0 0.0 … 0.0 -0.0;;; -0.24479721 0.15053843 … 0.0 0.0; -0.0 -0.0 … -0.0 -0.0; … ; 0.0 0.0 … 0.0 -0.0; -0.0 -0.0 … 0.0 0.0012546288;;; 0.0 0.0 … -0.0014435663 -0.0; -0.0 0.0 … 0.0 -0.0; … ; 0.0 -0.0 … 0.0 -0.0; 0.0 0.0 … 0.0 -0.0;;; -0.26935643 0.7366872 … 0.023180569 -0.0; 0.0 -0.13628483 … 0.080618836 -0.014470379; … ; -0.0 -0.0 … -0.04581676 0.12145349; -0.0 0.066990815 … -0.007093106 -0.22065108;;; -1.6617384 0.0 … -0.0063490737 0.0; 0.19575569 -0.0 … 0.0 0.0; … ; 0.005779806 -0.0 … -0.0 0.0; 0.049812254 -0.0 … -0.0 -0.0;;; -0.4333353 0.45968026 … 0.0007536393 -0.0; 4.14291 0.31524512 … -0.0 -0.0; … ; -0.21561722 0.0 … -0.055972423 0.0; 0.095998034 -0.0 … 0.0 -0.0;;; -0.00846924 -0.0 … -0.0 -0.0010797185; -0.0 -0.0 … 0.0 0.0; … ; -0.0 -0.0 … -0.0 0.0; -0.0 -0.0 … -0.0 0.0;;;;], Float32[0.0 1.7338208 … -0.12243356 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 -0.040996037 … 0.0 -0.23713431;;; 0.17873831 0.0 … -0.012817901 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.09406895;;; 0.09424246 0.0 … 0.0 0.02892367; 0.0 0.0 … 0.0 0.0; … ; 0.20836219 0.0 … -0.123721875 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.025748733; … ; 0.0 0.026334224 … 0.0 -0.018025182; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; -0.61772066 0.0 … 0.010083605 0.0; … ; 0.042392273 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 -0.090530805;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.044599567; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.00059791247;;; 0.0 0.0 … 0.0 0.0; -0.7828957 0.0 … 0.0 0.0038241963; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … -0.0023665845 0.0;;; 0.0 0.0 … 0.0 0.0; -2.8125021 0.0 … 0.0 -0.042949572; … ; 0.0 -0.074302495 … 0.0 0.0; 0.0 0.0 … 0.2378258 0.0;;;;], Float32[1.7338208 3.851122 … -0.19882658 -0.12243356; 0.1316247 2.5310667 … -0.23949209 -0.1665396; … ; -0.10049834 -0.3913721 … -0.091237746 -0.43444562; -0.040996037 -0.28633308 … -0.119615346 -0.23713431;;; 0.17873833 0.116805546 … 0.012957972 -0.012817901; -0.0 0.15504111 … 0.0 0.0022652745; … ; 0.0 0.12657644 … 0.0 0.0023302187; -0.0 -0.0 … 0.0 0.09406895;;; 0.09424247 -0.0 … -0.0017325603 0.02892367; 0.25551707 1.2050196 … 0.1307571 0.029264282; … ; 0.63687867 0.11898349 … 0.015140035 -0.14131516; 0.20836219 0.012075004 … 0.1466776 -0.123721875;;; 0.0 -1.080045 … 0.0035067177 0.025748733; -0.6693574 -2.0525804 … 0.0068440763 0.020850137; … ; 0.096560925 0.22055228 … 0.11640455 0.22443637; 0.026334224 -0.06937486 … -0.0042640422 -0.018025182;;; -0.61772066 -0.1232138 … 0.0 0.010083605; 0.008459759 0.80486417 … 0.017625215 0.014452096; … ; 0.13364168 -0.0 … -0.0 0.005737003; 0.042392273 -0.21196657 … 0.0 -0.090530805;;; -0.0 0.7232118 … 0.03375444 0.044599567; 0.0 -0.0 … -0.005422096 -0.03234706; … ; -0.0 -0.0 … 0.02877645 0.16854672; -0.0 -0.0 … -0.0 0.0005979125;;; -0.7828957 -1.0989537 … 0.06172209 0.0038241965; -0.2482519 0.26440275 … 0.0068995915 0.002907133; … ; -0.0 -0.049321633 … -0.008166726 0.0; 0.0 0.044736832 … -0.07819686 -0.0023665845;;; -2.8125021 0.34316805 … -0.05884785 -0.042949572; 0.7677717 -0.32200736 … -0.17832656 -0.0317245; … ; 0.0016934791 0.15471876 … -0.12584242 0.0322435; -0.074302495 -0.050413664 … -0.19342294 0.2378258;;;;], Float32[-0.00089921214 -0.0010458247 … 0.0008585434 -0.002881567; 8.199782f-5 0.0009019624 … -0.002117394 0.000790054; … ; -0.028801728 -0.0017066424 … -0.004829496 0.0008635315; 0.004131994 0.00029507233 … 0.00040404077 0.0017076617;;; -0.0 0.0 … 0.0 -0.0; 0.0 -0.0 … -0.0 -0.0; … ; -0.0 -0.0 … 0.0 0.0; 0.0 0.0 … 0.0 -0.0;;; -0.00017059724 0.0013456582 … 0.00014181763 -4.1567087f-5; 0.00072015694 -0.00043008104 … 0.0005094755 -0.00011042026; … ; 3.874266f-6 0.0011573051 … -0.00026333984 -0.00035081446; -0.0002873741 -1.609921f-6 … -2.7609558f-5 5.638684f-7;;; … ;;; -0.0022341346 -0.0006987261 … -0.013815433 -0.008569883; -0.0006363738 1.2469996f-5 … 0.026671031 9.173023f-5; … ; -0.0046676914 -0.0005850403 … -0.098587915 0.050283328; -0.0019599602 6.619957f-5 … 0.02179517 0.0002943603;;; -6.976221f-5 6.074718f-5 … 5.725768f-5 -4.280818f-5; -6.986087f-5 -6.4583845f-5 … 5.752706f-6 -3.6592213f-5; … ; -4.263109f-5 -8.450739f-6 … -6.994307f-5 -7.001688f-5; -5.1426156f-5 -4.8946913f-5 … -0.00017549697 -0.00029878356;;; 0.00011963224 -0.0023823318 … -0.0034629826 0.0014405632; -0.0098739285 -0.014144636 … 0.0026796912 0.00035043908; … ; 0.0014415641 0.0017130864 … 0.0047126133 0.002510494; 0.0023589002 0.0017901954 … 0.0014432106 -0.008553931;;;;], Float32[0.0 0.0 … -0.0 -0.0017066232; -0.0 -0.0 … -0.0 0.0; … ; -0.03568259 -0.008228494 … 0.0 -0.0; 0.011615866 -0.0 … 0.0 0.0068225875;;; 0.0 -0.0 … -0.0 0.0; -0.0 0.0 … -0.0 0.0; … ; 0.0 0.0 … -0.0 -0.0; -0.0 -0.0 … -0.0 0.0;;; -0.0 0.0 … -0.0 0.0; 0.0 -0.0033480327 … 0.004017303 0.0; … ; -0.0 -0.0 … -0.0 -0.0; 0.0 0.0 … -0.0 -0.00097437564;;; … ;;; 0.0 0.0 … -0.008684644 -0.0; -0.0 7.389647f-5 … 0.021985639 0.0008437006; … ; -0.0 -0.0 … -0.07383365 0.024128301; -0.0 0.00026739406 … 0.0050642057 0.0040971655;;; -0.0 0.0 … -0.0 -0.0; -0.0 -0.0 … -0.0 0.0; … ; -0.0 0.0 … -0.0 -0.0; -0.0 0.0 … -0.0018004492 -0.0058929455;;; 6.1968094f-5 -0.0077898945 … -0.025432702 0.0005767749; 0.0014351568 0.00010267493 … 0.017983818 0.000651443; … ; 0.07056718 -0.047224797 … 0.008022284 -0.0037512432; 0.0037748679 0.00450763 … 0.03474925 -0.0;;;;], Float32[-3.3325312f-5 -0.00017826338 … -0.00020438814 -0.00020539206; 0.00068953837 -0.07694176 … -0.122031786 0.00025205995; … ; 0.00019340216 4.836506f-5 … 0.00044969874 0.0008956994; 9.793097f-5 -0.00012228708 … 0.0009021426 -0.0001593572;;; -0.0 -0.0 … -0.0 -0.0; -0.0 -0.0 … -0.0 -0.0; … ; -0.00021879972 -0.013167139 … -0.0 -0.002442614; -0.00015017384 0.01828635 … -0.0 -4.6185363f-5;;; -1.8505812f-5 -0.007432196 … -0.00018587025 0.005959967; -0.0 -0.0 … -3.9761602f-5 -0.00083782413; … ; -0.0 -0.0 … -0.0 -0.02347478; -0.0 -1.0232004f-5 … -0.0 0.008591375;;; -0.0 -0.0 … -0.0003701338 -0.00047859145; -0.0 -0.0 … -0.03342214 -0.02839905; … ; -0.0 -0.0 … -0.0037468572 -0.0039010053; -0.0 -0.0 … -0.0 0.117798835;;; -0.0027319975 -0.005899734 … -0.0 0.00087959884; -0.011831052 0.0013672316 … -0.0 -0.0; … ; -0.0 -0.0 … -0.0 -0.0; -0.0 -0.0 … -0.0 -0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 -0.0007309043; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0010577278;;; 0.009115409 0.008959621 … 0.0 0.007192431; 0.0056773755 -0.12588762 … 0.015259585 0.005265954; … ; -0.18206847 0.10130724 … 0.0020270604 0.0027161262; 0.013759035 0.0058403467 … 0.0064706746 0.00086527;;; -0.0 -0.0 … -0.0 -0.0; -0.0 -0.0 … 9.014744f-5 0.007410235; … ; -0.0066623646 -0.0 … -0.0 -0.0; 0.0061852788 -0.015589275 … -0.0 -0.0;;;;], Float32[-0.00055416557 0.012380404 … 0.007827002 -0.011371136; -0.042891935 -0.009682141 … -0.026183074 -0.008833629; … ; 0.025374988 0.005983194 … -0.015748601 -0.030914197; -0.013286925 -0.006897915 … -0.007124729 0.0033512379;;; -0.0 0.0 … 0.0 0.0; 0.0 -0.0 … -0.0 0.0; … ; 0.0006503408 -0.0031721222 … -0.0 -9.1982394f-5; 0.0002698504 0.016464256 … -0.0 0.00022412343;;; -0.0007964664 -0.0042959084 … 0.0005006007 0.0042693494; -0.0 0.0 … -0.00061555806 -0.00035194075; … ; -0.0 -0.0 … -0.0 -0.018739935; -0.0 0.00078281865 … 0.0 0.005281899;;; 0.0 0.0 … 0.0050607473 0.0020562124; -0.0 0.0 … -0.018264052 -0.014616163; … ; 0.0 0.0 … -0.000118607735 0.00020325139; -0.0 -0.0 … 0.0 0.004669591;;; -0.0018563531 -0.00550178 … 0.0 0.0005665746; -0.007826219 0.0011107483 … 0.0 0.0; … ; 0.0 0.0 … 0.0 -0.0; -0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … -0.0 0.0; -0.0 -0.0 … 0.0 -0.0007087961; … ; 0.0 -0.0 … -0.0 -0.0; -0.0 0.0 … 0.0 0.000986472;;; -0.007080388 -0.012109492 … -0.0 6.179443f-5; 0.0030599365 -0.011945099 … 0.010592999 -0.001102475; … ; -0.020493738 0.027251843 … 1.6059183f-5 4.618293f-5; 0.0027885265 -0.0034510354 … -0.00069733715 -0.0010707441;;; 0.0 0.0 … -0.0 0.0; -0.0 -0.0 … 6.208371f-5 0.011823851; … ; -0.0038774698 0.0 … -0.0 0.0; 0.006990608 -0.0071241213 … -0.0 -0.0;;;;], Float32[-0.00055416557; -0.042891935; … ; 0.0; -0.0;;], Float32[0.0; 0.0; … ; -0.0; -0.0;;], Float32[0.0; 0.0; … ; -0.0; -0.0;;], Float32[0.0; 0.0; … ; 0.0; 0.0;;])</code></pre><p>Note that the layerwise relevances are only kept for layers in the outermost <code>Chain</code> of the model. When using our unflattened model, we only obtain three layerwise relevances, one for each chain in the model and the output relevance:</p><pre><code class="language-julia hljs">analyzer = LRP(model; flatten=false) # use unflattened model

expl = analyze(input, analyzer; layerwise_relevances=true)
expl.extras.layerwise_relevances</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(Float32[-0.05972938 -1.1307658 … 0.02715864 -0.056941014; -0.098280184 -2.161763 … 0.27187923 0.06447358; … ; 0.3466534 -0.91558963 … 0.289447 -0.34546357; 0.05798293 -0.21600471 … 0.13960607 0.0626343;;; -2.7449605 1.008628 … -0.10494528 0.19687822; -1.3198087 -0.030405646 … -0.04941288 -0.40895438; … ; -1.5269275 -0.7885271 … -0.8548043 -0.2810714; -0.3242127 0.0042319326 … -0.052424543 0.030853743;;; 2.3348064 1.983497 … 0.03579852 0.04896402; -1.1169053 1.6824868 … -0.06400592 0.027134625; … ; 0.66467416 -0.46424896 … -0.16213807 -0.00248512; 0.046551745 -0.7140521 … -0.2203997 0.044639315;;;;], Float32[-0.0 0.009214516 … 0.0046576583 -0.0074905423; -0.034835298 -0.010121663 … -0.026376354 -0.012413611; … ; 0.02131187 0.004132649 … -0.010741552 -0.031618632; -0.01084379 -0.0048890086 … -0.01043972 0.0053557153;;; 0.0 0.0 … 0.0 0.0; 0.0 -0.0 … -0.0 0.0; … ; 0.0006550855 -0.0032415867 … -0.0 0.00010764498; -1.2830812f-5 0.014896929 … -0.0 0.0;;; -0.0013723554 -0.0048589283 … -0.00017304288 0.00469354; -0.0 -0.0 … -0.0 0.002140769; … ; -0.0 -0.0 … -0.0 -0.021813517; -0.0 0.0 … 0.0 0.0027404695;;; -0.0 0.0 … 0.0045491243 0.001283862; -0.0 0.0 … -0.022938866 -0.019399999; … ; 0.0 0.0 … -0.002079168 0.00267676; -0.0 -0.0 … 0.0 0.0062415972;;; -0.0009767707 -0.0093420865 … -0.0 0.0008251876; -0.007287679 0.003955221 … 0.0 0.0; … ; 0.0 0.0 … 0.0 -0.0; -0.0 0.0 … 0.0 0.0;;; 0.0 -0.0 … -0.0 0.0; -0.0 -0.0 … 0.0 -0.00041465554; … ; 0.0 -0.0 … -0.0 0.0; -0.0 0.0 … 0.0 0.0026949132;;; -0.0057798782 -0.00996488 … -0.0 0.0008952963; 0.0023461257 -0.0131362835 … 0.01054183 -0.00031583043; … ; -0.023172958 0.025420513 … 0.0 0.0; 0.001349482 -0.0033222365 … 0.0004620211 -0.0;;; 0.0 0.0 … -0.0 0.0; -0.0 -0.0 … -3.6710757f-5 0.011128509; … ; -0.0040000845 0.0 … -0.0 0.000110371744; 0.00946087 -0.008096464 … 0.0 -0.0;;;;], Float32[0.0; 0.0; … ; 0.0; 0.0;;])</code></pre><h2 id="docs-lrp-performance"><a class="docs-heading-anchor" href="#docs-lrp-performance">Performance tips</a><a id="docs-lrp-performance-1"></a><a class="docs-heading-anchor-permalink" href="#docs-lrp-performance" title="Permalink"></a></h2><h3 id="gpu-docs"><a class="docs-heading-anchor" href="#gpu-docs">Using LRP with a GPU</a><a id="gpu-docs-1"></a><a class="docs-heading-anchor-permalink" href="#gpu-docs" title="Permalink"></a></h3><p>All LRP analyzers support GPU backends, building on top of <a href="https://fluxml.ai/Flux.jl/stable/gpu/">Flux.jl's GPU support</a>. Using a GPU only requires moving the input array and model weights to the GPU.</p><p>For example, using <a href="https://github.com/JuliaGPU/CUDA.jl">CUDA.jl</a>:</p><pre><code class="language-julia hljs">using CUDA, cuDNN
using Flux
using ExplainableAI

# move input array and model weights to GPU
input = input |&gt; gpu # or gpu(input)
model = model |&gt; gpu # or gpu(model)

# analyzers don't require calling `gpu`
analyzer = LRP(model)

# explanations are computed on the GPU
expl = analyze(input, analyzer)</code></pre><p>Some operations, like saving, require moving explanations back to the CPU. This can be done using Flux's <code>cpu</code> function:</p><pre><code class="language-julia hljs">val = expl.val |&gt; cpu # or cpu(expl.val)

using BSON
BSON.@save "explanation.bson" val</code></pre><h3 id="Using-LRP-without-a-GPU"><a class="docs-heading-anchor" href="#Using-LRP-without-a-GPU">Using LRP without a GPU</a><a id="Using-LRP-without-a-GPU-1"></a><a class="docs-heading-anchor-permalink" href="#Using-LRP-without-a-GPU" title="Permalink"></a></h3><p>Using Julia's package extension mechanism, RelevancePropagation.jl's LRP implementation can optionally make use of <a href="https://github.com/mcabbott/Tullio.jl">Tullio.jl</a> and <a href="https://github.com/JuliaSIMD/LoopVectorization.jl">LoopVectorization.jl</a> for faster LRP rules on dense layers.</p><p>This only requires loading the packages before loading RelevancePropagation.jl:</p><pre><code class="language-julia hljs">using LoopVectorization, Tullio
using RelevancePropagation</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>G. Montavon et al., <a href="https://link.springer.com/chapter/10.1007/978-3-030-28954-6_10">Layer-Wise Relevance Propagation: An Overview</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><a class="docs-footer-nextpage" href="../composites/">Assigning rules to layers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label></p><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div><p></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Tuesday 16 January 2024 16:14">Tuesday 16 January 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></HTML>